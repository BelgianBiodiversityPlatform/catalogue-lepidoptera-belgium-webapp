{% extends "lepidoptera/base.html" %}

{% block content %}
    <h2>Browse data</h2>

    <script type="text/x-template" id="content-entry-simplelist-template">
        <div>
            <h2>[[ jsonData.resultsTitle ]]</h2>
            <ul>
                <li v-for="entry in jsonData.entries"><a :href="entry.link">[[ entry.name ]]</a></li>
            </ul>
        </div>
    </script>

    <script type="text/x-template" id="tab-selector-template">
        <div class="list-group">
            <a v-for="entry in entries" :href="entry.target" class="list-group-item list-group-item-action"
               :class="{ active: entry.target === selected }"
               v-on:click.prevent="$emit('clicked-entry', entry.target)">

               [[ entry.label ]]
            </a>
        </div>
    </script>

    <script type="text/x-template" id="content-entry-template">
        <div class="tab-pane fade show" :id="htmlId" role="tabpanel">
            <span v-if="currentlyLoading">Loading...</span>

            <div v-else>
                <content-entry-simplelist :json-data="fromServer"></content-entry-simplelist>
            </div>
        </div>
    </script>

    <script type="text/x-template" id="results-zone-template">
        <div class="tab-content" id="nav-tabContent">
            <content-entry v-for="entry in entries" :key="entry.target" :html-id="entry.target"
                           :active="entry.target === selected"
                           :class="{ active: entry.target === selected }"
                           :service-url="entry.url">
            </content-entry>
        </div>
    </script>

    <div id="browse-module" class="row">
        <div class="col-4"><tab-selector :entries="menuEntries" :selected="selectedEntryTarget" v-on:clicked-entry="selectedEntry"></tab-selector></div>
        <div class="col-8"><results-zone :entries="menuEntries" :selected="selectedEntryTarget"></results-zone></div>
    </div>
{% endblock content %}

{% block bottom-of-body %}
    <script type="text/javascript">
    $(function () {
        var browseConf = {
            hostPlantsFamiliesUrl: "{% url 'browse_hostplants_families_json' %}",
            hostPlantsGeneraUrl: "{% url 'browse_hostplants_genera_json' %}",
        };

        Vue.component('content-entry-simplelist', {
            delimiters: ['[[', ']]'],
            template: '#content-entry-simplelist-template',
            props: {
                jsonData: Object
            }
        });

        Vue.component('content-entry', {
            delimiters: ['[[', ']]'],
            template: '#content-entry-template',
            props: {
                htmlId: String,
                active: Boolean,
                serviceUrl: String
            },
            data: function() {
                return {
                    fromServer: {},
                    alreadyLoaded: false,
                    currentlyLoading: false
                }
            },
            watch: {
                active: {
                    immediate: true,
                    handler (newVal, oldVal) {
                        if (newVal === true && !this.alreadyLoaded) {
                            var that = this;
                            that.currentlyLoading = true;
                            $.getJSON(this.serviceUrl, {})
                                .done(function (json) {
                                    that.fromServer = json;
                                    that.alreadyLoaded = true;
                            })
                            .fail(function (jqxhr, textStatus, error) {
                                alert("error");
                            })
                                .always(function() {
                                    that.currentlyLoading = false
                                })
                        }
                    }
                }
            }
        });

        Vue.component('tab-selector', {
            delimiters: ['[[', ']]'],
            template: '#tab-selector-template',
            props: {
                entries: Array,
                selected: String
            },

        });

        Vue.component('results-zone', {
            delimiters: ['[[', ']]'],
            template: '#results-zone-template',
            props: {
                entries: Array,
                selected: String
            },
        });

        var vm = new Vue({
            delimiters: ['[[', ']]'],
            el: '#browse-module',
            data: {
                menuEntries: [
                    {label: 'Taxonomy (lepidoptera)', target: '#list-taxonomy'},
                    {label: 'Vernacular names', target: '#list-vernacularnames'},
                    {label: 'Host plants families', target: '#list-hostplants-families', url: browseConf.hostPlantsFamiliesUrl},
                    {label: 'Host plants genera', target: '#list-hostplants-genera', url: browseConf.hostPlantsGeneraUrl},
                    {label: 'Substrates', target: '#substrates'},
                    {label: 'Publications', target: '#list-publications'},
                ],
                selectedEntryTarget: '#list-taxonomy'
            },
            methods: {
                selectedEntry: function(selectedTarget) {
                    if (selectedTarget != this.selectedEntryTarget) { // Ignore if we click on the entry already selected
                        this.selectedEntryTarget = selectedTarget;
                    }

                }
            }
        });

    });
    </script>
{% endblock %}