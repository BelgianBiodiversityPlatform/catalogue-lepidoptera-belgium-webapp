{% extends "lepidoptera/taxonomy/base.html" %}
{% load i18n %}

{% block extra-head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.2.0/leaflet-providers.min.js"></script>
    <style>
        .province {
            stroke-width: 1.5;
            fill: lightgrey;
            stroke: red;
        }

        .activeprovince {
            stroke: green !important;
            stroke-width: 2.5 !important;
        }

        .activeText {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block details %}

    <script type="text/x-template" id="country-grape-template">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">[[ period.period_name ]]</h5>
                    <svg width="300" height="112">
                        <province-icon v-for="province in provinces"
                                       :pos-x="province.posX"
                                       :pos-y="province.posY"
                                       :province-code="province.name"
                                       :is-active="province.active"
                                       :key="province.name"></province-icon>

                        <half-province-icon v-for="province in specialProvinces"
                                            :pos-x="province.posX"
                                            :pos-y="province.posY"
                                            :start-angle="province.startAngle"
                                            :end-angle="province.endAngle"
                                            :province-code="province.name"
                                            :is-active="province.active"
                                            :key="province.name"></half-province-icon>
                    </svg>
                </div>
            </div>
        </div>
    </script>

    <script type="text/x-template" id="half-province-icon-template">
        <g>
            <path fill="none" :d="moveList" class="province" v-bind:class="{ activeprovince: isActive }"/>

            <text :x="posX" :y="textPosY" fill="black" text-anchor="middle" dominant-baseline="middle" font-size="9"
                  v-bind:class="{ activeText: isActive }">
                [[ provinceCode ]]
            </text>
        </g>
    </script>

    <script type="text/x-template" id="province-icon-template">
        <g>
            <circle
                    :cx="posX"
                    :cy="posY"
                    :r="radius"
                    class="province"
                    v-bind:class="{ activeprovince: isActive }"/>

            <text :x="posX" :y="posY" fill="black" text-anchor="middle" dominant-baseline="middle" font-size="11"
                  v-bind:class="{ activeText: isActive }">
                [[ provinceCode ]]
            </text>

        </g>
    </script>

    <h2>{% trans "Distribution" %}</h2>

    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pills-grape-tab" data-toggle="pill" href="#pills-grape" role="tab"
               aria-controls="pills-grape" aria-selected="true">Grape view</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-table-tab" data-toggle="pill" href="#pills-table" role="tab"
               aria-controls="pills-table" aria-selected="false">Table view </a>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-grape" role="tabpanel" aria-labelledby="pills-grape-tab">
            <div class="row" id="distribution-grapefruit">
                <country-grape v-for="period in periods" :period="period" :key="period.period_name"></country-grape>
                {% include 'lepidoptera/taxonomy/_species_presence_province_legend.html' with provinces=all_provinces %}
            </div>
        </div>

        <div class="tab-pane fade" id="pills-table" role="tabpanel" aria-labelledby="pills-table-tab">
            <div class="row">
                <div class="col">
                    {% include 'lepidoptera/taxonomy/_species_presence_province_legend.html' with provinces=all_provinces %}
                    {% include "lepidoptera/taxonomy/_species_table.html" with species_list=species_as_a_list provinces=all_provinces timeperiods=all_timeperiods %}
                </div>
            </div>
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col">
            <h2>{% trans "Flight periods" %}</h2>
            <div id="mapid"></div>
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col">
            <h2>{% trans "Observed on" %}</h2>
        </div>
    </div>

    <hr>

    <dl class="row">
        {% if plant_species_observations %}
            <dt class="col-sm-3">{% trans "Host plant (species)" %}:</dt>
            <dd class="col-sm-9">
                {% for observation in plant_species_observations %}
                    <a href="{{ observation.plant_species.get_absolute_url }}">{{ observation.plant_species.html_str }}</a>
                    {% include 'lepidoptera/_comma.html' %}
                {% endfor %}
            </dd>
        {% endif %}

        {% if plant_genus_observations %}
            <dt class="col-sm-3">{% trans "Host plant (genera)" %}:</dt>
            <dd class="col-sm-9">
                {% for observation in plant_genus_observations %}
                    <a href="{{ observation.plant_genus.get_absolute_url }}">{{ observation.plant_genus }}</a>
                    {% include 'lepidoptera/_comma.html' %}
                {% endfor %}
            </dd>
        {% endif %}

        {% if substrate_observations %}
            <dt class="col-sm-3">{% trans "Substrates" %}:</dt>
            <dd class="col-sm-9">
                {% for observation in substrate_observations %}
                    <a href="{{ observation.substrate.get_absolute_url }}">{{ observation.substrate }}</a>
                    {% include 'lepidoptera/_comma.html' %}
                {% endfor %}
            </dd>
        {% endif %}
    </dl>

    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='imago' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='egg' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='larva' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='case' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='bag' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='mine' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='cocoon' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='bionomics' %}
    {% include 'lepidoptera/taxonomy/_species_section.html' with species=taxon section_name='habitat' %}

{% endblock %}

{% block bottom-of-body %}
    <script type="text/javascript">
        $(function () {
            var pageConf = {
                presenceJSONUrl: "{% url 'species_per_province_and_period' %}",
                speciesId: {{ taxon.pk }},
                circleRadius: 15
            };

            // Set up the lightbox
            $(document).on('click', '[data-toggle="lightbox"]', function (event) {
                event.preventDefault();
                $(this).ekkoLightbox();
            });

            // And the map
            var mymap = L.map('mapid').setView([50.5038, 4.4699], 8);
            var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mymap);

            // And Vue
            Vue.component('half-province-icon', {
                delimiters: ['[[', ']]'],
                template: '#half-province-icon-template',
                props: {
                    posX: Number,
                    posY: Number,
                    startAngle: Number,
                    endAngle: Number,

                    isActive: Boolean,
                    provinceCode: String
                },
                data: function () {
                    return {
                        moveList: this.describeArc(this.posX, this.posY, pageConf.circleRadius, this.startAngle,
                            this.endAngle),
                        textPosY: this.getTextYPos()
                    }
                },
                methods: {
                    getTextYPos: function() {
                        if (this.startAngle < this.endAngle) {
                            return this.posY + 5;
                        } else {
                            return this.posY - 5;
                        }
                    },
                    describeArc: function (x, y, radius, startAngle, endAngle) {
                        var polarToCartesian = function (centerX, centerY, radius, angleInDegrees) {
                            var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;

                            return {
                                x: centerX + (radius * Math.cos(angleInRadians)),
                                y: centerY + (radius * Math.sin(angleInRadians))
                            };
                        }

                        var start = polarToCartesian(x, y, radius, endAngle);
                        var end = polarToCartesian(x, y, radius, startAngle);

                        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

                        var d = [
                            "M", start.x, start.y,
                            "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
                        ].join(" ");

                        return d;
                    }
                }
            });

            Vue.component('province-icon', {
                delimiters: ['[[', ']]'],
                template: '#province-icon-template',
                props: {
                    posX: Number,
                    posY: Number,
                    isActive: Boolean,
                    provinceCode: String
                },
                data: function () {
                    return {
                        'radius': pageConf.circleRadius
                    }
                }
            });

            Vue.component('country-grape', {
                delimiters: ['[[', ']]'],
                template: '#country-grape-template',
                props: {
                    period: Object // has a name, and a list of provinces codes where the species is present
                },
                data: function () {
                    var activateProvinces = function (presences, provinces) {
                        var i, j;

                        for (i = 0; i < presences.length; i++) {
                            for (j = 0; j < provinces.length; j++) {
                                if (provinces[j]['name'] === presences[i]) {
                                    provinces[j].active = true;
                                }

                                if (provinces[j]['partOf'] === presences[i]) {
                                    provinces[j].active = true;
                                }
                            }
                        }
                        return provinces;
                    };

                    var provinces = [
                        /* Brabant is not displayed as a full province but as the aggregate of BRW and VBR*/
                        {name: 'NA', posX: 160, posY: 80, active: false},
                        {name: 'LX', posX: 188, posY: 96, active: false},
                        {name: 'LG', posX: 188, posY: 64, active: false},
                        {name: 'LI', posX: 188, posY: 32, active: false},
                        {name: 'AN', posX: 160, posY: 16, active: false},
                        {name: 'OV', posX: 132, posY: 32, active: false},
                        {name: 'HA', posX: 132, posY: 64, active: false},
                        {name: 'WV', posX: 104, posY: 48, active: false}
                    ];

                    var specialProvinces = [
                        {name: 'BRW', posX: 160, posY: 48, startAngle: 90, endAngle: 270, active: false, partOf: 'BR'},
                        {name: 'VBR', posX: 160, posY: 48, startAngle: 270, endAngle: 90, active: false, partOf: 'BR'}
                    ];

                    return {
                        provinces: activateProvinces(this.period.present_in, provinces),
                        specialProvinces: activateProvinces(this.period.present_in, specialProvinces)
                    }
                }
            });

            var vm = new Vue({
                delimiters: ['[[', ']]'],
                el: '#distribution-grapefruit',
                data: {
                    speciesId: pageConf.speciesId,
                    periods: []
                },
                mounted: function () {
                    this.$nextTick(function () {
                        this.loadData();
                    })
                },
                methods: {
                    loadData: function () {
                        var that = this;
                        $.getJSON(pageConf.presenceJSONUrl, {speciesId: this.speciesId})
                            .done(function (json) {
                                that.periods = json;
                            })
                            .fail(function (jqxhr, textStatus, error) {
                                alert("error");
                            })
                    }
                }
            });

        });
    </script>
{% endblock %}