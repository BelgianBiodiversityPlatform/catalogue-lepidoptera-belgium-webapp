{% extends "lepidoptera/base.html" %}

{% load i18n %}

{% block content %}
    <h1>{% trans "Gallery" %}</h1>

    <script type="text/x-template" id="search-form-template">
        <div id="search-options">
            <h2>Filters</h2>

            <div class="form-group row">
                <label for="stage-select" class="col-sm-2 col-form-label">Specimen stage: </label>
                <div class="col-sm-10">
                    <select id="stage-select" class="form-control form-control-sm" v-model="selectedStage" @change="changeFilters()">
                        <option v-for="stage in stages" v-bind:value="stage.value">[[ stage.text ]]</option>
                    </select>
                </div>

                <label for="stage-select" class="col-sm-2 col-form-label">Subject: </label>
                <div class="col-sm-10">
                    <select id="subject-select" class="form-control form-control-sm" v-model="selectedSubject" @change="changeFilters()">
                        <option v-for="subject in subjects" v-bind:value="subject.value">[[ subject.text ]]</option>
                    </select>
                </div>
            </div>
        </div>
    </script>

    <div id="gallery-container" v-cloak>
        <search-form initial-selected-stage="*"
                     initial-selected-subject="*"
                     v-bind:filter-choices="filterChoices">
        </search-form>

        <div id="results">
            <span v-for="picture in pictures" class="result">
                <a :href="picture.fullSizeURL"
                   data-toggle="lightbox"
                   data-gallery="results-gallery"
                   :data-title="picture.HTMLSpeciesName"
                   :data-footer="picture.HTMLMetadata">
                    <img :src="picture.thumbnaillURL" class="img-fluid img-thumbnail">
                </a>
            </span>

            <infinite-loading @infinite="infiniteHandler" ref="infiniteLoading">
                <span slot="no-more">
                    No more pictures :(
                </span>
            </infinite-loading>
        </div>
    </div>

{% endblock %}

{% block extra-head %}
    <style>[v-cloak] {
        display: none
    }</style>
{% endblock %}

{% block bottom-of-body %}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-infinite-loading@2.3.1/dist/vue-infinite-loading.min.js"></script>

    <script>
        $(function () {
            var galleryConf = {
                picsJSONUrl: "{% url 'pictures_json' %}",
                picsPerPage: {{ settings.GALLERY_PAGE_SIZE }},
                filtersChoices: {{ filters_choices|safe }}
            };

            Vue.component('search-form', {
                delimiters: ['[[', ']]'],
                template: '#search-form-template',
                props: [
                    'initialSelectedStage',
                    'initialSelectedSubject',
                    'filterChoices'
                ],

                data: function() {
                    // Prepare the (received via props) stage choices for the template, and add all/none options
                    var allNoneChoices = [
                            {'value': '',  'text': '--None--'},
                            {'value': '*', 'text': '--All--'}
                    ];

                    var stagesForSelect = allNoneChoices.slice();
                    for (var i = 0; i < this.filterChoices.specimenStages.length; i++) {
                        stagesForSelect.push({'value': this.filterChoices.specimenStages[i][0], 'text': this.filterChoices.specimenStages[i][1]});
                    };

                    var subjectsForSelect = allNoneChoices.slice();
                    for (var i = 0; i < this.filterChoices.imageSubjects.length; i++) {
                        subjectsForSelect.push({'value': this.filterChoices.imageSubjects[i][0], 'text': this.filterChoices.imageSubjects[i][1]})
                    };

                    return {
                        stages: stagesForSelect,
                        subjects: subjectsForSelect,
                        selectedStage: this.initialSelectedStage,
                        selectedSubject: this.initialSelectedSubject,
                    }
                },

                mounted: function () {
                    this.$nextTick(function () {
                        // After page load, launch a first search with selected filter
                        this.changeFilters()
                    })
                },

                methods: {
                    changeFilters: function() {
                        this.$parent.changeFilter(this.selectedStage, this.selectedSubject);
                    },
                }
            })

            var vm = new Vue({
                delimiters: ['[[', ']]'],
                el: '#gallery-container',
                data: {
                    pictures: [],
                    filters: {'stage': '', 'subject': ''},
                    filterChoices: galleryConf.filtersChoices
                },
                methods: {
                    infiniteHandler: function($state) {
                        var that = this;
                        $.getJSON(galleryConf.picsJSONUrl, {
                            page: this.pictures.length / galleryConf.picsPerPage + 1,
                            filters_stage: this.filters.stage,
                            filters_subject: this.filters.subject
                        })
                            .done(function (json) {
                                var results = json.results;
                                var hasMoreResults = json.hasMoreResults;

                                that.pictures = that.pictures.concat(results);
                                $state.loaded();
                                if (!hasMoreResults) {
                                    $state.complete()
                                }
                            })
                            .fail(function (jqxhr, textStatus, error) {
                                alert("error");
                            })

                    },

                    changeFilter: function(stage, subject) {
                        this.filters.stage = stage
                        this.filters.subject = subject
                        this.pictures = [];
                        this.$nextTick(()=> {
                            this.$refs.infiniteLoading.$emit('$InfiniteLoading:reset');
                        });
                    },
                }
            });

        });
    </script>
{% endblock %}